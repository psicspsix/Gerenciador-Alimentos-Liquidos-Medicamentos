<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Medicamentos</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: #e0e0e0; text-align: center; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        h1 { color: #ffffff; font-size: 36px; margin: 0; }
        #currentTime { font-size: 28px; color: #e0e0e0; }
        .nav-buttons { margin: 20px 0; display: flex; justify-content: space-between; align-items: center; }
        .report-buttons-left { display: flex; justify-content: flex-start; flex-grow: 1; }
        .report-buttons-right { display: flex; justify-content: flex-end; }
        button, input { font-size: 24px; padding: 15px; margin: 10px; background: #333; color: #e0e0e0; border: 1px solid #555; }
        button:hover { background: #555; }
        .screen { display: none; }
        .screen.active { display: block; }
        ul { list-style-type: none; padding: 0; }
        #medList li { font-size: 28px; margin: 15px 0; background: #2a2a2a; padding: 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .next-time { font-size: 36px; font-weight: bold; }
        .same-day { color: #ffff00; } /* Amarelo */
        .future-day { color: #1e90ff; } /* Azul */
        .on-time { color: #00ff00; } /* Verde */
        .late { color: #ff5555; } /* Vermelho claro */
        #mainError, #mainSuccess { font-size: 24px; margin: 10px 0; }
        [id$="Error"] { color: #ff5555; }
        [id$="Success"] { color: #55ff55; }
    </style>
</head>
<body>
    <div id="mainScreen" class="screen active">
        <div class="header">
            <h1>Gerenciador de Medicamentos</h1>
            <span id="currentTime"></span>
        </div>
        <div class="nav-buttons">
            <button id="goToUser">Usuário</button>
            <button id="goToAdd">Cadastrar Item</button>
            <button id="goToEdit">Alterar Item</button>
            <button id="goToDelete">Excluir ou Mudar Status do Item</button>
            <button id="goToReport">Relatórios</button>
        </div>
        <ul id="medList"></ul>
        <div id="mainError"></div>
        <div id="mainSuccess"></div>
    </div>

    <div id="reportScreen" class="screen">
        <h2>Relatórios</h2>
        <div class="nav-buttons">
            <div class="report-buttons-left">
                <button id="dailyReport">Diário</button>
                <button id="weeklyReport">Semanal</button>
                <button id="monthlyReport">Mensal</button>
            </div>
            <div class="report-buttons-right">
                <button id="backToMainFromReport">Voltar</button>
            </div>
        </div>
        <ul id="reportList"></ul>
    </div>

    <!-- Outras telas (userScreen, addScreen, editScreen, deleteScreen) omitidas para brevidade -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8pHaMGwaR3-_36A1mYJ0UzAwOdBk-9zw",
            authDomain: "gerenciador-medicamentos.firebaseapp.com",
            databaseURL: "https://gerenciador-medicamentos-default-rtdb.firebaseio.com",
            projectId: "gerenciador-medicamentos",
            storageBucket: "gerenciador-medicamentos.firebasestorage.app",
            messagingSenderId: "182430581876",
            appId: "1:182430581876:web:e5e6462c7c70dd4326bd21",
            measurementId: "G-FXWHXJFSN4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const usersRef = ref(db, 'users');
        const lastUserRef = ref(db, 'lastUser');
        let currentUserId = null;

        function getMedsRef() {
            return currentUserId ? ref(db, `users/${currentUserId}/medications`) : ref(db, 'medications');
        }

        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
        }
        setInterval(updateCurrentTime, 60000);
        updateCurrentTime();

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'mainScreen') renderMainScreen();
            else if (screenId === 'reportScreen') renderReport('daily'); // Default para diário
        }

        function formatDateTime(dateTime) {
            if (!dateTime) return '<span>Aguardando!</span>';
            const date = new Date(dateTime); // UTC do Firebase
            const dateLocal = new Date(date.getTime() - 3 * 60 * 60 * 1000); // Ajusta para GMT-3
            const hours = String(dateLocal.getHours()).padStart(2, '0');
            const minutes = String(dateLocal.getMinutes()).padStart(2, '0');
            let className = '';
            const now = new Date(); // Horário local (GMT-3)
            const today = new Date(now);
            today.setHours(0, 0, 0, 0); // Meia-noite do dia atual
            const due = new Date(dateLocal);
            due.setHours(0, 0, 0, 0); // Meia-noite do dia do próximo horário
            const diffDays = Math.floor((due - today) / (24 * 60 * 60 * 1000));
            if (diffDays === 0) className = 'same-day'; // Amarelo
            else if (diffDays >= 1) className = 'future-day'; // Azul
            return `<span class="${className}">${hours}:${minutes}</span>`;
        }

        function getNextTime(lastTaken, periodicity) {
            if (!lastTaken) return null;
            const last = new Date(lastTaken); // UTC do Firebase
            const lastLocal = new Date(last.getTime() - 3 * 60 * 60 * 1000); // Converte para GMT-3
            const periodMs = periodicity * 60 * 60 * 1000; // Periodicidade em milissegundos
            const nextTimeLocalMs = lastLocal.getTime() + periodMs; // Próximo horário em GMT-3
            return new Date(nextTimeLocalMs); // Retorna como objeto Date em GMT-3
        }

        onValue(lastUserRef, (snapshot) => {
            const lastUser = snapshot.val();
            if (lastUser && lastUser.id) {
                currentUserId = lastUser.id;
                onValue(ref(db, `users/${currentUserId}`), (userSnapshot) => {
                    const user = userSnapshot.val();
                    if (user && user.name) {
                        const firstName = user.name.split(' ')[0];
                        document.getElementById('goToUser').textContent = firstName;
                    }
                }, { onlyOnce: true });
                renderMainScreen();
            }
        });

        function renderMainScreen() {
            const medsRef = getMedsRef();
            onValue(medsRef, (snapshot) => {
                const meds = snapshot.val() || {};
                const medList = document.getElementById('medList');
                medList.innerHTML = meds ? '' : '<li>Nenhum medicamento cadastrado!</li>';

                Object.entries(meds).filter(([_, med]) => med.enabled !== false).forEach(([key, med]) => {
                    const li = document.createElement('li');
                    const nextTime = getNextTime(med.lastTaken, med.periodicity);
                    li.innerHTML = `
                        ${med.name} | Próximo: <span class="next-time">${formatDateTime(nextTime ? nextTime.toISOString() : null)}</span>
                        | Tomado às: <input type="text" id="taken-${key}" value="" placeholder="hhmm" maxlength="4">
                        <button id="currentTime-${key}">Hora Atual</button>
                    `;
                    medList.appendChild(li);

                    li.querySelector(`#taken-${key}`).addEventListener('change', (e) => {
                        const value = e.target.value;
                        if (/^\d{4}$/.test(value)) {
                            const hours = parseInt(value.slice(0, 2));
                            const minutes = parseInt(value.slice(2, 4));
                            if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
                                const localDate = new Date();
                                localDate.setHours(hours, minutes, 0, 0);
                                const utcDate = new Date(localDate.getTime() + 3 * 60 * 60 * 1000); // Converte para UTC
                                const newLastTaken = utcDate.toISOString();
                                update(ref(db, `users/${currentUserId}/medications/${key}`), { 
                                    lastTaken: newLastTaken,
                                    history: med.history ? [...med.history, newLastTaken] : [newLastTaken]
                                }).then(() => {
                                    e.target.value = '';
                                }).catch((error) => {
                                    document.getElementById('mainError').textContent = "Erro ao registrar: " + error.message;
                                });
                            } else {
                                document.getElementById('mainError').textContent = "Horário inválido!";
                            }
                        } else {
                            document.getElementById('mainError').textContent = "Digite hhmm (ex.: 1556)!";
                        }
                    });

                    li.querySelector(`#currentTime-${key}`).addEventListener('click', () => {
                        const now = new Date();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        const localDate = new Date();
                        localDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                        const utcDate = new Date(localDate.getTime() + 3 * 60 * 60 * 1000);
                        const newLastTaken = utcDate.toISOString();
                        update(ref(db, `users/${currentUserId}/medications/${key}`), { 
                            lastTaken: newLastTaken,
                            history: med.history ? [...med.history, newLastTaken] : [newLastTaken]
                        }).then(() => {
                            document.getElementById(`taken-${key}`).value = '';
                        }).catch((error) => {
                            document.getElementById('mainError').textContent = "Erro ao registrar: " + error.message;
                        });
                    });
                });
            });
        }

        function renderReport(type) {
            const reportList = document.getElementById('reportList');
            reportList.innerHTML = '';
            const medsRef = getMedsRef();
            onValue(medsRef, (snapshot) => {
                const meds = snapshot.val() || {};
                Object.entries(meds).filter(([_, med]) => med.enabled !== false).forEach(([_, med]) => {
                    const li = document.createElement('li');
                    const lastTaken = med.lastTaken ? new Date(med.lastTaken) : null; // UTC
                    const lastTakenLocal = lastTaken ? new Date(lastTaken.getTime() - 3 * 60 * 60 * 1000) : null; // GMT-3
                    const nextTimeLocal = lastTaken ? getNextTime(med.lastTaken, med.periodicity) : null; // GMT-3
                    const lastTakenStr = lastTakenLocal ? `${String(lastTakenLocal.getDate()).padStart(2, '0')}/${String(lastTakenLocal.getMonth() + 1).padStart(2, '0')}/${lastTakenLocal.getFullYear()}, ${String(lastTakenLocal.getHours()).padStart(2, '0')}:${String(lastTakenLocal.getMinutes()).padStart(2, '0')}` : 'Nenhum registro';
                    const nextTimeStr = nextTimeLocal ? `${String(nextTimeLocal.getDate()).padStart(2, '0')}/${String(nextTimeLocal.getMonth() + 1).padStart(2, '0')}/${nextTimeLocal.getFullYear()}, ${String(nextTimeLocal.getHours()).padStart(2, '0')}:${String(nextTimeLocal.getMinutes()).padStart(2, '0')}` : 'Nenhum';

                    if (type === 'daily') {
                        const now = new Date(); // Horário local (GMT-3)
                        const today = new Date(now);
                        today.setHours(0, 0, 0, 0); // Início do dia atual
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1); // Início do dia seguinte
                        if (nextTimeLocal && nextTimeLocal >= lastTakenLocal) {
                            li.innerHTML = `${med.name} | Tomado: ${lastTakenStr} | Esperado: ${nextTimeStr}`;
                            reportList.appendChild(li);
                        }
                    } else if (type === 'weekly' || type === 'monthly') {
                        li.innerHTML = `${med.name} | Tomado: ${lastTakenStr} | Esperado: ${nextTimeStr}`;
                        reportList.appendChild(li);
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('goToUser').addEventListener('click', () => showScreen('userScreen'));
            document.getElementById('goToAdd').addEventListener('click', () => showScreen('addScreen'));
            document.getElementById('goToEdit').addEventListener('click', () => showScreen('editScreen'));
            document.getElementById('goToDelete').addEventListener('click', () => showScreen('deleteScreen'));
            document.getElementById('goToReport').addEventListener('click', () => showScreen('reportScreen'));

            // Botões de relatório
            document.getElementById('dailyReport').addEventListener('click', () => renderReport('daily'));
            document.getElementById('weeklyReport').addEventListener('click', () => renderReport('weekly'));
            document.getElementById('monthlyReport').addEventListener('click', () => renderReport('monthly'));
            document.getElementById('backToMainFromReport').addEventListener('click', () => showScreen('mainScreen'));
        });

        // Atualização automática da tela inicial a cada minuto
        setInterval(renderMainScreen, 60000);
    </script>
</body>
</html>
