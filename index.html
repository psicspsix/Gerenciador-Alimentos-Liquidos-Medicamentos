<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Medicamentos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
            text-align: center;
        }
        h1 {
            color: #ffffff;
            font-size: 36px;
            margin: 0;
        }
        .nav-buttons {
            margin: 20px 0;
        }
        button, input {
            font-size: 24px;
            padding: 15px;
            margin: 10px;
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        button:hover {
            background: #555;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            font-size: 28px;
            margin: 15px 0;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .next-time {
            font-size: 36px;
            font-weight: bold;
        }
        .date-today { color: #1e90ff; } /* Azul */
        .date-one-day-past { color: #ffff00; } /* Amarelo */
        .date-two-plus-days-past { color: #ff0000; } /* Vermelho */
        #mainError, #addError, #editError, #deleteError, 
        #mainSuccess, #addSuccess, #editSuccess, #deleteSuccess {
            font-size: 24px;
            margin: 10px 0;
        }
        [id$="Error"] { color: #ff5555; }
        [id$="Success"] { color: #55ff55; }
    </style>
</head>
<body>
    <div id="mainScreen" class="screen active">
        <h1>Gerenciador de Medicamentos</h1>
        <div class="nav-buttons">
            <button id="goToAdd">Cadastrar Item</button>
            <button id="goToEdit">Alterar Item Já Cadastrado</button>
            <button id="goToDelete">Excluir ou Desabilitar Item</button>
        </div>
        <ul id="medList"></ul>
        <div id="mainError"></div>
        <div id="mainSuccess"></div>
    </div>

    <div id="addScreen" class="screen">
        <h1>Cadastrar Item</h1>
        <input type="text" id="addNameInput" placeholder="Nome do item">
        <input type="number" id="addPeriodInput" placeholder="Periodicidade (horas)">
        <button id="saveAdd">Salvar</button>
        <button id="backFromAdd">Voltar</button>
        <div id="addError"></div>
        <div id="addSuccess"></div>
    </div>

    <div id="editScreen" class="screen">
        <h1>Alterar Item Já Cadastrado</h1>
        <ul id="editMedList"></ul>
        <button id="backFromEdit">Voltar</button>
        <div id="editError"></div>
        <div id="editSuccess"></div>
    </div>

    <div id="deleteScreen" class="screen">
        <h1>Excluir ou Desabilitar Item</h1>
        <ul id="deleteMedList"></ul>
        <button id="backFromDelete">Voltar</button>
        <div id="deleteError"></div>
        <div id="deleteSuccess"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8pHaMGwaR3-_36A1mYJ0UzAwOdBk-9zw",
            authDomain: "gerenciador-medicamentos.firebaseapp.com",
            databaseURL: "https://gerenciador-medicamentos-default-rtdb.firebaseio.com",
            projectId: "gerenciador-medicamentos",
            storageBucket: "gerenciador-medicamentos.firebasestorage.app",
            messagingSenderId: "182430581876",
            appId: "1:182430581876:web:e5e6462c7c70dd4326bd21",
            measurementId: "G-FXWHXJFSN4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const medsRef = ref(db, 'medications');

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'editScreen') renderEditScreen();
            if (screenId === 'deleteScreen') renderDeleteScreen();
        }

        function formatDateTime(dateTime) {
            if (!dateTime) return '';
            const date = new Date(dateTime);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            let className = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dateTime);
            due.setHours(0, 0, 0, 0);
            const diffMs = today.getTime() - due.getTime();
            const oneDayMs = 24 * 60 * 60 * 1000;
            if (diffMs === 0) className = 'date-today';
            else if (diffMs === oneDayMs) className = 'date-one-day-past';
            else if (diffMs >= 2 * oneDayMs) className = 'date-two-plus-days-past';
            return `<span class="${className}">${hours}:${minutes}</span>`;
        }

        function getNextTime(lastTaken, periodicity) {
            const now = new Date();
            if (!lastTaken) return now.toISOString();
            const last = new Date(lastTaken);
            const periodMs = periodicity * 60 * 60 * 1000;
            let next = last.getTime();
            while (next <= now.getTime()) {
                next += periodMs;
            }
            return new Date(next).toISOString();
        }

        onValue(medsRef, (snapshot) => {
            const meds = snapshot.val() || {};
            const medList = document.getElementById('medList');
            medList.innerHTML = meds ? '' : '<li>Nenhum medicamento, alimento ou líquido cadastrado!</li>';

            Object.entries(meds).filter(([_, med]) => med.enabled !== false).forEach(([key, med]) => {
                const li = document.createElement('li');
                const nextTime = getNextTime(med.lastTaken, med.periodicity);
                li.innerHTML = `
                    ${med.name} | Próximo: <span class="next-time">${formatDateTime(nextTime)}</span>
                    | Tomado às: <input type="text" id="taken-${key}" value="${med.lastTaken ? med.lastTaken.split('T')[1].slice(0, 5) : ''}" placeholder="hh:mm" maxlength="5">
                `;
                li.querySelector(`#taken-${key}`).addEventListener('change', (e) => {
                    const value = e.target.value;
                    if (/^\d{2}:\d{2}$/.test(value)) {
                        const today = new Date().toISOString().split('T')[0];
                        update(ref(db, `medications/${key}`), { lastTaken: `${today}T${value}:00Z` });
                    }
                });
                medList.appendChild(li);
            });
        });

        function addMedication() {
            const nameInput = document.getElementById('addNameInput');
            const periodInput = document.getElementById('addPeriodInput');
            const name = nameInput.value.trim();
            const periodicity = parseInt(periodInput.value);

            if (!name || isNaN(periodicity) || periodicity <= 0) {
                document.getElementById('addError').textContent = "Preencha nome e periodicidade válida!";
                return;
            }

            push(medsRef, {
                name,
                periodicity,
                lastTaken: null,
                enabled: true
            }).then(() => {
                nameInput.value = '';
                periodInput.value = '';
                document.getElementById('addError').textContent = '';
                document.getElementById('addSuccess').textContent = "Item cadastrado com sucesso!";
                setTimeout(() => document.getElementById('addSuccess').textContent = '', 2000);
                showScreen('mainScreen');
            }).catch((error) => {
                document.getElementById('addError').textContent = "Erro ao cadastrar: " + error.message;
            });
        }

        function renderEditScreen() {
            onValue(medsRef, (snapshot) => {
                const meds = snapshot.val() || {};
                const editList = document.getElementById('editMedList');
                editList.innerHTML = '';
                Object.entries(meds).forEach(([key, med]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <input type="text" id="editName-${key}" value="${med.name}">
                        <input type="number" id="editPeriod-${key}" value="${med.periodicity}">
                        <button id="saveEdit-${key}">Salvar</button>
                    `;
                    editList.appendChild(li);
                    document.getElementById(`saveEdit-${key}`).addEventListener('click', () => saveEdit(key));
                });
            });
        }

        function saveEdit(key) {
            const name = document.getElementById(`editName-${key}`).value.trim();
            const periodicity = parseInt(document.getElementById(`editPeriod-${key}`).value);
            if (!name || isNaN(periodicity) || periodicity <= 0) {
                document.getElementById('editError').textContent = "Preencha nome e periodicidade válida!";
                return;
            }
            update(ref(db, `medications/${key}`), { name, periodicity });
            document.getElementById('editSuccess').textContent = "Item atualizado com sucesso!";
            setTimeout(() => document.getElementById('editSuccess').textContent = '', 2000);
            showScreen('mainScreen');
        }

        function renderDeleteScreen() {
            onValue(medsRef, (snapshot) => {
                const meds = snapshot.val() || {};
                const deleteList = document.getElementById('deleteMedList');
                deleteList.innerHTML = '';
                Object.entries(meds).forEach(([key, med]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        ${med.name} | Periodicidade: ${med.periodicity}h
                        <button id="disable-${key}">Desabilitar</button>
                        <button id="delete-${key}">Excluir</button>
                    `;
                    deleteList.appendChild(li);
                    document.getElementById(`disable-${key}`).addEventListener('click', () => disableItem(key));
                    document.getElementById(`delete-${key}`).addEventListener('click', () => deleteItem(key));
                });
            });
        }

        function disableItem(key) {
            update(ref(db, `medications/${key}`), { enabled: false });
            document.getElementById('deleteSuccess').textContent = "Item desabilitado com sucesso!";
            setTimeout(() => document.getElementById('deleteSuccess').textContent = '', 2000);
            showScreen('mainScreen');
        }

        function disableItem(key) {
            update(ref(db, `medications/${key}`), { enabled: false });
            document.getElementById('deleteSuccess').textContent = "Item desabilitado com sucesso!";
            setTimeout(() => document.getElementById('deleteSuccess').textContent = '', 2000);
            showScreen('mainScreen');
        }
        function deleteItem(key) {
            remove(ref(db, `medications/${key}`));
            document.getElementById('deleteSuccess').textContent = "Item excluído com sucesso!";
            setTimeout(() => document.getElementById('deleteSuccess').textContent = '', 2000);
            showScreen('mainScreen');
        }

        // Vincula eventos aos botões de navegação
        document.getElementById('goToAdd').addEventListener('click', () => showScreen('addScreen'));
        document.getElementById('goToEdit').addEventListener('click', () => showScreen('editScreen'));
        document.getElementById('goToDelete').addEventListener('click', () => showScreen('deleteScreen'));
        document.getElementById('saveAdd').addEventListener('click', addMedication);
        document.getElementById('backFromAdd').addEventListener('click', () => showScreen('mainScreen'));
        document.getElementById('backFromEdit').addEventListener('click', () => showScreen('mainScreen'));
        document.getElementById('backFromDelete').addEventListener('click', () => showScreen('mainScreen'));
    </script>
</body>
</html>
